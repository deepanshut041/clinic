<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Clinic</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- <link rel="stylesheet" type="text/css" media="screen" href="main.css" />
    <script src="main.js"></script> -->
</head>

<body>
    <div>
        <form id="serviceForm">
            <select id="servicesSelect">
                <option value="0">Any Service</option>
            </select>
            <input id="pinCode" type="number">
            <button id="getClinicsButton">Locate Clinics</button>
        </form>
    </div>
    <div id="googleMap" style="width:100%;height:400px;"></div>

    </div>
    <div>
        <p>Clinic :
            <span id="clinicName"></span>
        </p>
        <p>Suburb :
            <span id="clinicSuburb"></span>
        </p>
        <p>State :
            <span id="clinicState"></span>
        </p>
        <p>Email :
            <span id="clinicEmail"></span>
        </p>
    </div>
    <script src="http://code.jquery.com/jquery-latest.min.js" type="text/javascript"></script>
    <script src="https://maps.googleapis.com/maps/api/js"></script>

    <script>
        var pin_code = null
        var markers = []
        $(document).ready(function () {
            //Send the AJAX call to the server for services
            $.ajax({
                url: 'http://localhost:5000/getservices',
                type: 'GET',
                dataType: "json",

                success: function (data) {
                    $.each(data, function (key, value) {
                        $('#servicesSelect')
                            .append($("<option></option>")
                                .attr("value", value['ServiceID'])
                                .text(value['Service']));
                    });
                },
                error: function (error) {
                    console.log(error)
                }
            })

        });

        $('#getClinicsButton').click(function () {
            var service_id = $('#servicesSelect').find(":selected").val();
            var markers = []
            pin_code = $('#pinCode').val();
            if (pin_code != '') {
                $.ajax({
                    url: 'http://localhost:5000/getclinics?serviceid=' + service_id,
                    type: 'GET',
                    dataType: 'json',
                    success: function (data) {
                        var geocoder = new google.maps.Geocoder();
                        geocoder.geocode({
                            'address': pin_code, "componentRestrictions": { "country": "AU" }
                        }, function (results, status) {
                            if (status == google.maps.GeocoderStatus.OK) {
                                var mapProp = {
                                    center: results[0].geometry.location,
                                    zoom: 6,
                                };
                                var map = new google.maps.Map(document.getElementById("googleMap"), mapProp);
                                markers = [];
                                $.each(data, function (key, value) {
                                    marker = new google.maps.Marker({
                                        position: { lat: value['Lat'], lng: value['Lon'] },
                                        title: value['Clinic'],
                                        map: map
                                    });
                                    markers.push(marker)
                                });

                                $.each(markers, function (key, marker) {
                                    google.maps.event.addListener(marker, 'click', function () {
                                        current_data = data[key]
                                        $('#clinicName').text(current_data['Clinic']);
                                        $('#clinicSuburb').text(current_data['Suburb']);
                                        $('#clinicState').text(current_data['State']);
                                        $('#clinicEmail').text(current_data['Email']);
                                    });
                                });


                            } else {
                                alert("Geocode was not successful for the following reason: " + status);
                            }
                        });
                    }
                });
            }
            else {
                console.log("Enter pincode")
            }
        });

        $("#serviceForm").submit(function (e) {
            return false;
        });

        $('#clinicEmail').on('click', function () {
            window.location.href = "mailto:"+ $('#clinicEmail').text() +"?subject=Clinic Enquiry";
        });


    </script>
</body>

</html>